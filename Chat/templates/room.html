{% extends "base.html" %}
{% block content %}
<!-- –°—Ç–∏–ª–∏ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ style.css, –∑–¥–µ—Å—å –æ–Ω–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ -->
<style>
  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
  .messages {
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    max-height: 60vh;
    padding: 0 10px;
  }

  /* –°–æ–æ–±—â–µ–Ω–∏—è –≤ –≤–∏–¥–µ "–æ–±–ª–∞–∫–æ–≤" */
  .text {
    display: inline-block;
    border-radius: 20px;
    padding: 10px 15px;
    margin: 5px 0;
    max-width: 70%;
    word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.5s ease-out;
  }

  /* –°–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–∞–º–∏ */
  .own-message {
    align-self: flex-end;
  }

</style>

<div class="message-box">
    <h2>–ß–∞—Ç-–∫–æ–º–Ω–∞—Ç–∞: {{ code }}</h2>

    <div style="text-align: center; margin-bottom: 10px;">
        <a href="{{ url_for('leave_chat', chat_name=code) }}" class="leave-link">–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã</a>
    </div>

    <div class="messages" id="messages"></div>

    <div class="inputs">
        <textarea id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
        <button type="button" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button type="button" id="record-btn">üéô –ó–∞–ø–∏—Å—å</button>
        <button type="button" id="file-btn">üìé –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="file-input" hidden>
    </div>
</div>

<script type="text/javascript">
    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏
    let currentUsername = "{{ session['username'] }}";

    const socketio = io();
    const messagesContainer = document.getElementById("messages");
    const inputMessage = document.getElementById("message");
    const sendButton = document.getElementById("send-btn");
    const recordButton = document.getElementById("record-btn");
    const fileBtn = document.getElementById("file-btn");
    const fileInput = document.getElementById("file-input");
        fileBtn.addEventListener("click", function() {
        console.log("file-btn clicked");
        fileInput.click();
    });

    function createMessage(id, name, msg, timestamp) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–≤–æ–∏–º (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
        let isOwn = (name === currentUsername);

        const messageElement = document.createElement("div");
        messageElement.classList.add("text");
        if (isOwn) {
            messageElement.classList.add("own-message");
        }
        messageElement.setAttribute("data-id", id);

        let buttons = "";
        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if (isOwn) {
            buttons = `
                <button class="edit-btn" onclick="editMessage('${id}', '${msg}')">‚úèÔ∏è</button>
                <button class="delete-btn" onclick="deleteMessage('${id}')">üóëÔ∏è</button>
            `;
        }

        messageElement.innerHTML = `
            <strong>${name}</strong>: <span class="message-content">${msg}</span>
            <span class="muted">${timestamp}</span>
            ${buttons}
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    socketio.on("connect", function() {
        socketio.emit("join_room", { room: "{{ code }}" });
    });

    socketio.on("message_history", function(data) {
        data.messages.forEach(msg => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π —Ñ–ª–∞–≥ isOwn, –≤—ã—á–∏—Å–ª—è–µ–º —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
            createMessage(msg.id, msg.name, msg.message, msg.timestamp);
        });
    });

    socketio.on("message", (data) => {
        createMessage(data.id, data.name, data.message, data.timestamp);
    });

    function sendMessage() {
        let message = inputMessage.value.trim();
        if (message === "") return;

        socketio.emit("message", { data: message });
        inputMessage.value = "";
    }

    sendButton.onclick = sendMessage;

    inputMessage.addEventListener("keydown", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    function editMessage(id, oldMessage) {
        const newMessage = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:", oldMessage);
        if (newMessage !== null && newMessage.trim() !== "") {
            socketio.emit("edit_message", { id, newMessage });
        }
    }

    function deleteMessage(id) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
            socketio.emit("delete_message", { id });
        }
    }

    socketio.on("update_message", function(data) {
        const messageElement = document.querySelector(`.text[data-id='${data.id}'] .message-content`);
        if (messageElement) {
            messageElement.textContent = data.newMessage;
        }
    });

    socketio.on("remove_message", function(data) {
        const messageElement = document.querySelector(`.text[data-id='${data.id}']`);
        if (messageElement) {
            messageElement.remove();
        }
    });

    // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    recordButton.onclick = function() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
            const recorder = new MediaRecorder(stream);
            recorder.start();

            setTimeout(() => {
                recorder.stop();
                recorder.ondataavailable = function(event) {
                    const reader = new FileReader();
                    reader.readAsDataURL(event.data);
                    reader.onloadend = function() {
                        socketio.emit("voice_message", { data: reader.result });
                    };
                };
            }, 5000);
        });
    };

    socketio.on("voice_message", function(data) {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = data.data;
        messagesContainer.appendChild(audio);
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onloadend = function() {
            socketio.emit("file_upload", { filename: file.name, data: reader.result });
        };
    };

    socketio.on("file_message", function(data) {
        const link = document.createElement("a");
        link.href = data.data;
        link.download = data.filename;
        link.textContent = `üìé ${data.filename}`;
        messagesContainer.appendChild(link);
    });
</script>
{% endblock %}
